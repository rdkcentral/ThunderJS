/**
 * If not stated otherwise in this file or this component's LICENSE file the
 * following copyright and licenses apply:
 *
 * Copyright 2021 Metrological
 *
 * Licensed under the Apache License, Version 2.0 (the License);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

var ThunderJS=function(){"use strict";function h(n){return(h="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(n){return typeof n}:function(n){return n&&"function"==typeof Symbol&&n.constructor===Symbol&&n!==Symbol.prototype?"symbol":typeof n})(n)}function e(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);n&&(o=o.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),t.push.apply(t,o)}return t}function t(r){for(var n=1;n<arguments.length;n++){var i=null!=arguments[n]?arguments[n]:{};n%2?e(Object(i),!0).forEach(function(n){var e,t,o;e=r,o=i[t=n],t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(i)):e(Object(i)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(i,n))})}return r}var n=null;"undefined"!=typeof WebSocket&&(n=WebSocket);function c(e){if("string"==typeof e&&(e=JSON.parse(e.normalize().replace(/\\x([0-9A-Fa-f]{2})/g,""))),!e.id&&e.method){var n=l[e.method];n&&Array.isArray(n)&&n.length&&n.forEach(function(n){n(e.params)})}}function u(n){return[n&&n.protocol||"ws://",n&&n.host||"localhost",":"+(n&&n.port||80),n&&n.endpoint||"/jsonrpc",n&&n.token?"?token="+n.token:null].join("")}function g(i){return new Promise(function(e,t){var o=u(i),r=f[o];if(r&&1===r.readyState)return e(r);if(r&&0===r.readyState){return r.addEventListener("open",function n(){r.removeEventListener("open",n),e(r)})}if(null==r){i.debug&&console.log("Opening socket to "+o),r=new s(o,i&&i.subprotocols||"notification"),(f[o]=r).addEventListener("message",function(n){i.debug&&(console.log(" "),console.log("API REPONSE:"),console.log(JSON.stringify(n.data,null,2)),console.log(" ")),function(n){if("string"==typeof n&&(n=JSON.parse(n.normalize().replace(/\\x([0-9A-Fa-f]{2})/g,""))),n.id){var e=v[n.id];e?("result"in n?e.resolve(n.result):e.reject(n.error),delete v[n.id]):console.log("no pending request found with id "+n.id)}}(n.data)}),r.addEventListener("message",function(n){c(n.data)}),r.addEventListener("error",function(){c({method:"client.ThunderJS.events.error"}),f[o]=null});var n=function(n){f[o]=null,t(n)};r.addEventListener("close",n),r.addEventListener("open",function(){c({method:"client.ThunderJS.events.connect"}),r.removeEventListener("close",n),r.addEventListener("close",function(){c({method:"client.ThunderJS.events.disconnect"}),f[o]=null}),e(r)})}else f[u(i)]=null,t("Socket error")})}function o(d){return{request:function(f,a,p){return new Promise(function(n,e){var t,o,r,i,c,u=y+=1,s=(t=d.versions,o=f,(i=(r=p)&&r.version)?i:t&&(t[o]||t.default)||1),l=function(n,e,t,o,r){o&&delete o.version;var i={jsonrpc:"2.0",id:n,method:[e,r,t].join(".")};return!o&&!1!==o||"object"===h(o)&&0===Object.keys(o).length||(i.params=o),i}(u,f,a,p,s);d.debug&&(console.log(" "),console.log("API REQUEST:"),console.log(JSON.stringify(l,null,2)),console.log(" ")),v[u]={body:l,resolve:n,reject:e},c=l,g(d).then(function(n){n.send(JSON.stringify(c))}).catch(function(n){e(n)})})}}}var s=n,v={},l={},f={},y=0,r={DeviceInfo:{freeRam:function(n){return this.call("systeminfo",n).then(function(n){return n.freeram})},version:function(n){return this.call("systeminfo",n).then(function(n){return n.version})}}};function i(e,t,n,o){var r=this,i=function(n,e,t,o){var r=a(n,e);if(!l[r]){l[r]=[];if(n!=="ThunderJS"){var i="register";var c=r.split(".").slice(0,-1).join(".");var u={event:e,id:c};this.api.request(n,i,u).catch(function(n){if(typeof o==="function")o(n.message)})}}return l[r].push(t),l[r].length-1}.call(this,e,t,n,o);return{dispose:function(){var n=a(e,t);void 0!==l[n]&&(l[n].splice(i,1),0===l[n].length&&function(n,e,t){var o=a(n,e);if(delete l[o],n!=="ThunderJS"){var r="unregister";var i=o.split(".").slice(0,-1).join(".");var c={event:e,id:i};this.api.request(n,r,c).catch(function(n){if(typeof t==="function")t(n.message)})}}.call(r,e,t,o))}}}function a(n,e){return["client",n,"events",e].join(".")}var p=function t(n){return{options:n,api:o(n),plugin:!1,call:function(){var n=Array.prototype.slice.call(arguments);this.plugin&&n[0]!==this.plugin&&n.unshift(this.plugin);var e=n[0],t=n[1];return"function"==typeof this[e][t]?this[e][t](n[2]):this.api.request.apply(this,n)},registerPlugin:function(n,e){this[n]=d(Object.assign(Object.create(t),e,{plugin:n}))},subscribe:function(){},on:function(){var n=Array.prototype.slice.call(arguments);return-1!==["connect","disconnect","error"].indexOf(n[0])?n.unshift("ThunderJS"):this.plugin&&n[0]!==this.plugin&&n.unshift(this.plugin),i.apply(this,n)},once:function(){console.log("todo ...")}}},d=function n(e){return new Proxy(e,{get:function(o,r){var i=o[r];return"api"===r?o.api:void 0!==i?"function"==typeof i?-1<["on","once","subscribe"].indexOf(r)?function(){for(var n=arguments.length,e=new Array(n),t=0;t<n;t++)e[t]=arguments[t];return i.apply(this,e)}:function(){for(var n=arguments.length,e=new Array(n),t=0;t<n;t++)e[t]=arguments[t];return function(t,n){"object"===h(t)&&("object"!==h(t)||t.then&&"function"==typeof t.then)||(t=new Promise(function(n,e){(t instanceof Error==!1?n:e)(t)}));var e="function"==typeof n[n.length-1]?n[n.length-1]:null;if(!e)return t;t.then(function(n){return e(null,n)}).catch(function(n){return e(n)})}(i.apply(this,e),e)}:"object"===h(i)?n(Object.assign(Object.create(p(o.options)),i,{plugin:r})):i:!1===o.plugin?n(Object.assign(Object.create(p(o.options)),{},{plugin:r})):function(){for(var n=arguments.length,e=new Array(n),t=0;t<n;t++)e[t]=arguments[t];return e.unshift(r),o.call.apply(this,e)}}})};return function(n){return void 0===n.token&&"undefined"!=typeof window&&window.thunder&&"function"==typeof window.thunder.token&&(n.token=window.thunder.token()),d(t({},p(n),{},r))}}();
